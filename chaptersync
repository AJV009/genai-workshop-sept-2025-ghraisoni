#!/bin/bash

# ChapterSync - Copy ready sessions from private repo to public repo
echo "ğŸ”„ ChapterSync - Syncing ready sessions from private repo..."

PRIVATE_REPO="../genai-workshop-sept-2025-ghraisoni-private"
PUBLIC_REPO="."

# Check if private repo exists
if [ ! -d "$PRIVATE_REPO" ]; then
    echo "âŒ Error: Private repo not found at $PRIVATE_REPO"
    exit 1
fi

# Check if we're in a git repo
if [ ! -d ".git" ]; then
    echo "âŒ Error: Not in a git repository"
    exit 1
fi

echo "ğŸ“ Private repo: $PRIVATE_REPO"
echo "ğŸ“ Public repo: $PUBLIC_REPO"
echo ""

# Find all ready sessions in private repo
ready_sessions=()
for session_dir in "$PRIVATE_REPO"/session*/; do
    if [ -f "$session_dir/.chapter" ]; then
        status=$(grep "status:" "$session_dir/.chapter" | cut -d' ' -f2)
        if [ "$status" = "ready" ]; then
            chapter_num=$(grep "chapter:" "$session_dir/.chapter" | cut -d' ' -f2)
            session_name=$(basename "$session_dir")
            ready_sessions+=("$session_name")
            echo "âœ… Found ready session: $session_name (Chapter $chapter_num)"
        fi
    fi
done

if [ ${#ready_sessions[@]} -eq 0 ]; then
    echo "â„¹ï¸  No ready sessions found"
    exit 0
fi

echo ""
echo "ğŸš€ Syncing ${#ready_sessions[@]} ready session(s) to public repo..."

# Remove all existing session folders
echo "ğŸ—‘ï¸  Removing existing session folders..."
rm -rf session*/

# Copy ready sessions from private to public
for session in "${ready_sessions[@]}"; do
    echo "ğŸ“ Copying $session..."
    cp -r "$PRIVATE_REPO/$session" "$PUBLIC_REPO/"
    # Remove .chapter files from public repo (keep them private)
    rm -f "$PUBLIC_REPO/$session/.chapter"
done

# Git operations
echo "ğŸ“¦ Adding files to git..."
git add .

echo "ğŸ’¬ Creating commit..."
git commit -m "Sync ready sessions: $(IFS=,; echo "${ready_sessions[*]}")

ğŸ¤– Auto-synced from private repo on $(date '+%Y-%m-%d %H:%M:%S')"

echo "ğŸ“¤ Force pushing to public repo..."
git push origin main --force

echo ""
echo "âœ… ChapterSync complete! Ready sessions synced to public repo."
echo "ğŸ“‹ Synced sessions: ${ready_sessions[@]}"